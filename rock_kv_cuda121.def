Bootstrap: docker
From: pytorch/pytorch:2.4.1-cuda12.1-cudnn9-devel

%files

%post
    # 更新系统包管理器
    apt-get update && apt-get install -y \
        git \
        wget \
        curl \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

    # 安装Python依赖
    pip install --upgrade pip

    # 安装matplotlib和seaborn
    pip install matplotlib
    pip install seaborn
    
    # 处理flash-attn
    pip uninstall -y flash-attn || true
    pip install flash-attn==2.7.4.post1 --no-build-isolation

    # 创建必要的目录

%environment
    # 设置环境变量
    export HF_HOME=/data/shared/huggingface
    export TOKENIZERS_PARALLELISM=false
    export HF_DATASETS_TRUST_REMOTE_CODE=1
    export PATH="/root/.local/bin:$PATH"

%runscript
    # 默认运行脚本
    exec "$@"

%help
    This container includes:
    - PyTorch 2.4.1 with CUDA 12.1 and cuDNN 9
    - matplotlib, seaborn for visualization
    - flash-attn 2.7.4.post1
    - Updated triton
    - Custom transformers (hf-4.53.2 branch)
    - Custom lm-evaluation-harness
    
    Usage:
    singularity exec --nv --bind /data:/data --bind /path/to/your/project:/workspace container.sif <command>
    
    Example:
    singularity exec --nv --bind /data:/data --bind $PWD:/workspace container.sif bash -c "cd /workspace && pip install -e . && eval_rock_kv Qwen/Qwen3-8B --task gsm8k_cot_llama --eval_rock_kv --channel_selection 3 --debug"
